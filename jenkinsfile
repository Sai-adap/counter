pipeline {
    agent any

    stages {
        stage('Install the dependencies') {
            steps {
                sh "npm install"
            }
        }

        stage('Build the code') {
            steps {
                sh "npm run build"
            }
        }

        stage('Deploy') {
            steps {
                 withCredentials([sshUserPrivateKey(credentialsId: 'counter-app-ssh-ec2', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER')]) {
                     sh '''
                        scp -i $SSH_KEY -r build/* $SSH_USER@13.233.136.224:/var/www/html
                        ssh -i $SSH_KEY $SSH_USER@13.233.136.224 'sudo systemctl restart httpd'
                     '''
                 }   
            }
        }
    }
}
